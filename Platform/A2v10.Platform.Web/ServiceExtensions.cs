// Copyright © 2020-2023 Oleksandr Kukhtin. All rights reserved.

using System;


using A2v10.Data.Interfaces;
using A2v10.Infrastructure;

using A2v10.Platform.Web;
using A2v10.Platform.Web.Controllers;

namespace Microsoft.Extensions.DependencyInjection;

public static class ServiceExtensions
{
	public static IMvcBuilder AddPlatformCore(this IServiceCollection services)
	{
		var webMvcAssembly = typeof(ShellController).Assembly;
		var builder = services.AddControllersWithViews()
			.AddApplicationPart(webMvcAssembly);

		/*
		services.Configure<MvcRazorRuntimeCompilationOptions>(opts => {
			opts.FileProviders.Add(new EmbeddedFileProvider(webMvcAssembly));
		});
		*/

		services.AddScoped<IApplicationTheme, WebApplicationTheme>();

		services.AddScoped<IApplicationHost, WebApplicationHost>()
		.AddScoped<ITenantManager, WebTenantManager>()
		.AddScoped<IAppTenantManager, AppTenantManager>()
		.AddScoped<IDataScripter, VueDataScripter>();

		services.AddScoped<IUserDevice, WebUserDevice>();

		services.AddScoped<WebLocalizer>()
			.AddScoped<ILocalizer>(s => s.GetRequiredService<WebLocalizer>())
			.AddScoped<IDataLocalizer>(s => s.GetRequiredService<WebLocalizer>());

		services.AddSingleton<WebProfilerStorage>()
			.AddScoped<WebProfiler>()
			.AddScoped<IProfiler>(s => s.GetRequiredService<WebProfiler>())
			.AddScoped<IDataProfiler>(s => s.GetRequiredService<WebProfiler>());

		services.AddSingleton<ILocalizerDictiorany, WebLocalizerDictiorany>();
		services.AddScoped<IAppDataProvider, WebAppDataProvider>();

		services.AddScoped<ITokenProvider, WebTokenProvider>();

		services.AddScoped<CurrentUser>()
			.AddScoped<ICurrentUser>(s => s.GetRequiredService<CurrentUser>())
			.AddScoped<IDbIdentity>(s => s.GetRequiredService<CurrentUser>());

		services.AddDistributedMemoryCache();
		services.AddSession();

		services.AddSingleton<ISignalSender, SignalSender>();

		return builder;
	}

	public static IServiceCollection AddViewEngines(this IServiceCollection services, Action<ViewEngineFactory> action)
	{
		var viewEngineFactory = new ViewEngineFactory();
		action.Invoke(viewEngineFactory);
		foreach (var e in viewEngineFactory.Engines)
			services.AddScoped(e.EngineType);

		services.AddScoped<IViewEngineProvider>(s =>
			new WebViewEngineProvider(s, viewEngineFactory.Engines)
		);
		return services;
	}

	public static IServiceCollection AddReportEngines(this IServiceCollection services, Action<ReportEngineFactory> action)
	{
		var reportEngineFactory = new ReportEngineFactory();
		action.Invoke(reportEngineFactory);
		foreach (var r in reportEngineFactory.Engines)
			services.AddScoped(r.EngineType);

		services.AddScoped<IReportEngineProvider>(s =>
			new WebReportEngineProvider(s, reportEngineFactory.Engines)
		);
		return services;
	}

	public static IServiceCollection AddInvokeTargets(this IServiceCollection services, Action<InvokeEngineFactory> action)
	{
		var invokeEngineFactory = new InvokeEngineFactory();
		action.Invoke(invokeEngineFactory);

		foreach (var r in invokeEngineFactory.Engines)
		{
			switch (r.Scope)
			{
				case InvokeScope.Scoped:
					services.AddScoped(r.EngineType);
					break;
				case InvokeScope.Singleton:
					services.AddSingleton(r.EngineType);
					break;
				case InvokeScope.Transient:
					services.AddTransient(r.EngineType);
					break;
				default:
					throw new InvalidProgramException($"Invalid Invoke scope: {r.Scope}");
			}
		}

		services.AddScoped<IInvokeEngineProvider>(s =>
			new WebInvokeEngineProvider(s, invokeEngineFactory.Engines)
		);
		return services;
	}

	public static IServiceCollection AddBlobStorages(this IServiceCollection services, Action<BlobStorageFactory> action)
	{
		var blobEngineFactory = new BlobStorageFactory();
		action.Invoke(blobEngineFactory);
		foreach (var r in blobEngineFactory.Engines)
			services.AddSingleton(r.StorageType);

		services.AddSingleton<IBlobStorageProvider>(s =>
			new WebBlobStorageProvider(s, blobEngineFactory.Engines)
		);
		return services;
	}
}
